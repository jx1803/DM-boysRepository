<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="org.great.mapper.DailyWorkMapper">

	<!-- 陈文炽完成功能 -->

	<!-- 报损审核 -->
	<update id="breakCheck"
		parameterType="org.great.bean.DrugApplyBean">
		update tbldrugapply set
		checkid=#{checkId} where drugapplyid=#{drugApplyId}
	</update>

	<!-- 报损申请 -->
	<insert id="breakApply"
		parameterType="org.great.bean.DrugApplyBean">
		insert into tbldrugapply
		(DRUGAPPLYID,ADMINID,DRUGID,APPLYNUM,APPLYDATE,CHECKID,APPLYTYPEID,APPLYREASON,manubatch,checkdate,putbatch)
		values
		(SPMSSEQ.NEXTVAL,#{adminId,jdbcType=NUMERIC},#{drugId,jdbcType=NUMERIC},#{applyNum,jdbcType=NUMERIC},
		to_char(sysdate,'YYYY-MM-DD
		HH24:MI:SS'),#{checkId,jdbcType=NUMERIC},#{applyTypeId,jdbcType=NUMERIC},
		#{applyReason,jdbcType=VARCHAR},#{manuBatch,jdbcType=VARCHAR},#{checkDate,jdbcType=VARCHAR},#{putBatch,jdbcType=VARCHAR})
	</insert>

	<!-- 查看申请记录 -->
	<select id="selectDrugApply"
		parameterType="org.great.bean.CondiBean" resultMap="drugApply">
		select * from(select d.*,a.adminname,s.drugname, p1.param
		checkname,s.drugmanu,b.batchdetailid,b.purPrice,p2.param
		applytype,rownum r from tbldrugapply d
		left join tblparam p1 on d.checkid=p1.paramid
		left join tblparam p2 on d.applytypeid=p2.paramid
		left join tbladmin a on d.adminid=a.adminid
		left join tblstodrug s on d.drugid=s.drugid
		left join tblBatchDetail b on b.batchdetailid=d.putbatch
		<where>

			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and d.applydate &gt;=#{afterDate}
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and d.applydate &lt;=#{beforeDate}
			</if>
			<if test="checkId!=0 ">
				and d.checkid=#{checkId}
			</if>
			<if test="applyTypeId!=0 ">
				and d.applytypeid =#{applyTypeId}
			</if>

		</where>

		)where r&gt;=#{pageNum}*#{pageLimit}-#{pageLimit}+1 and
		r&lt;=#{pageNum}*#{pageLimit}
	</select>

	<!-- 查询药品申请记录总数 -->
	<select id="getDrugApplyCount"
		parameterType="org.great.bean.CondiBean" resultType="Integer">
		select count(drugapplyid) from tbldrugapply d
		left join tbladmin a on d.adminid=a.adminid
		left join tblstodrug s on d.drugid=s.drugid
		<where>

			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and d.applydate &gt;=#{afterDate}
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and d.applydate &lt;=#{beforeDate}
			</if>
			<if test="checkId!=0 ">
				and d.checkid=#{checkId}
			</if>
			<if test="applyTypeId!=0 ">
				and d.applytypeid =#{applyTypeId}
			</if>

		</where>

	</select>

	<!-- 获取入库批次详情列表 -->
	<select id="selectPutDrug"
		parameterType="org.great.bean.CondiBean" resultMap="batchDetailMap">
		select
		s.drugname,s.drugmanu,b.putbatch,o.handledate,b.drugid,b.manubatch,b.purprice
		from tblbatchdetail b
		left join tblstodrug s on b.drugid=s.drugid
		left join tbloutandin o on b.putbatch=o.putbatch

		<where>
			<if test="afterDate!=null and afterDate!='' ">
				and o.handledate &gt;=#{afterDate}
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and o.handledate &lt;=#{beforeDate}
			</if>
			<if test="pinyinCode!=null and pinyinCode!=''">
				and s.pinyincode like concat(concat('%',#{pinyinCode}),'%')
			</if>
			<if test="drugName!=null and drugName!=''">
				and s.drugname like concat(concat('%',#{drugName}),'%')
			</if>
			<if test="manuBatch!=null and manuBatch!=''">
				and b.manuBatch like concat(concat('%',#{manuBatch}),'%')
			</if>
		</where>
		order by o.handledate
	</select>

	<!-- 插入药品调价记录 -->
	<insert id="insertAdjustPrice"
		parameterType="org.great.bean.AdjustPriceBean">
		insert into tbladjustprice
		(adjustpriceid,adjustdate,drugid,beforeadjust,afteradjust,adminid)
		values(spmsseq.nextval,to_char(sysdate,'YYYY-MM-DD
		HH24:MI:SS'),#{drugId,jdbcType=NUMERIC},
		#{beforeAdjust,jdbcType=NUMERIC},#{afterAdjust,jdbcType=NUMERIC},#{adminId,jdbcType=NUMERIC})
	</insert>

	<!-- 获取调价记录总数 -->
	<select id="getAdjustCount"
		parameterType="org.great.bean.CondiBean" resultType="Integer">
		select count(a.adjustpriceid) from tbladjustprice a
		left join tblstodrug s on a.drugid=s.drugid
		left join tbladmin m on a.adminid=m.adminid
		<where>
			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and o.handledate &gt;=#{afterDate}
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and o.handledate &lt;=#{beforeDate}
			</if>
			<if test="pinyinCode!=null and pinyinCode!=''">
				and s.pinyincode like concat(concat('%',#{pinyinCode}),'%')
			</if>
			<if test="drugName!=null and drugName!=''">
				and s.drugname like concat(concat('%',#{drugName}),'%')
			</if>
		</where>
	</select>

	<!-- 获取调价记录列表 -->
	<select id="selectAdjustPrice"
		parameterType="org.great.bean.CondiBean" resultMap="adjustPrice">
		select * from(select
		a.*,s.drugname,s.unit,s.specific,s.drugmanu,m.adminname,rownum r from
		tbladjustprice a
		left join tblstodrug s on a.drugid=s.drugid
		left join tbladmin m on a.adminid=m.adminid
		<where>
			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and o.handledate &gt;=#{afterDate}
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and o.handledate &lt;=#{beforeDate}
			</if>
			<if test="pinyinCode!=null and pinyinCode!=''">
				and s.pinyincode like concat(concat('%',#{pinyinCode}),'%')
			</if>
			<if test="drugName!=null and drugName!=''">
				and s.drugname like concat(concat('%',#{drugName}),'%')
			</if>
		</where>
		)where r&gt;=#{pageNum}*#{pageLimit}-#{pageLimit}+1 and
		r&lt;=#{pageNum}*#{pageLimit}
	</select>

	<!-- 调整药品价格 -->
	<update id="adjustPrice"
		parameterType="org.great.bean.AdjustPriceBean">
		update tblstodrug set retailprice=#{afterAdjust} where
		drugid=#{drugId}
	</update>

	<!-- 获取参数值（获取加成率） -->
	<select id="getParam" parameterType="Integer"
		resultType="org.great.bean.ParamBean">
		select * from tblparam where paramid=#{paramId}
	</select>



	<!-- 插入销售记录表 -->
	<insert id="insertSell" parameterType="org.great.bean.SellBean">
		insert into tblsell
		(SELLID,DRUGID,ADMINID,SELLNUM,SALES,SELLDATE,MANUBATCH)
		values(SPMSSEQ.NEXTVAL,#{drugId,jdbcType=NUMERIC},#{adminId,jdbcType=NUMERIC},#{sellNum,jdbcType=NUMERIC},
		#{sales,jdbcType=NUMERIC},to_char(sysdate,'YYYY-MM-DD
		HH24:MI:SS'),#{manuBatch,jdbcType=VARCHAR})
	</insert>

	<!-- 插入药房出库记录 -->
	<insert id="insertDrugOut"
		parameterType="org.great.bean.OutAndInBean">
		insert into
		tbloutandin(OUTANDINID,TOTALMONEY,PUTBATCH,PLACEID,OUTINID,DESTINATION,HANDLEDATE,ADMINID)
		values(SPMSSEQ.NEXTVAL,#{totalMoney,jdbcType=NUMERIC},#{putBatch,jdbcType=VARCHAR},21,17,
		#{destination,jdbcType=VARCHAR},to_char(sysdate,'YYYY-MM-DD
		HH24:MI:SS'),#{adminId,jdbcType=NUMERIC})
	</insert>



	<!-- 减少药房库存 -->
	<update id="reducePhaDrugNum"
		parameterType="org.great.bean.SellBean">
		update tblphadrug set drugnum=(select drugnum from
		tblphadrug where drugid=#{drugId})-#{sellNum}
		where drugid=#{drugId}
	</update>

	<!-- 减少药房库存2 -->
	<update id="reducePhaDrugNum2"
		parameterType="org.great.bean.DrugApplyBean">
		update tblphadrug set drugnum=(select drugnum from
		tblphadrug where drugid=#{drugId})-#{applyNum}
		where drugid=#{drugId}
	</update>

	<!-- 减少药房入库记录的药品数量 -->
	<update id="reducePhaPutDrugNum"
		parameterType="org.great.bean.SellBean">
		update tblbatchdetail set handlenum=(select handlenum
		from tblbatchdetail
		where batchdetailid=#{putBatch})-#{sellNum} where batchdetailid=#{putBatch}
	</update>

	<!-- 查询药房中的药品列表 -->
	<select id="selectPhaDrug"
		parameterType="org.great.bean.CondiBean" resultMap="phaDrugMap">
		select * from (select
		s.*,p.PHADRUGID,p.DRUGNUM,p.USEABLEID,p.MINIMUM,p.MAXIMUM,ROWNUM r
		from tblphadrug p
		left join tblstodrug s on p.drugid=s.drugid
		<where>
			<if test="pinyinCode!=null and pinyinCode!=''">
				and s.pinyincode like
				concat(concat('%',#{pinyinCode}),'%')
			</if>
			<if test="drugName!=null and drugName!=''">
				and s.drugname like concat(concat('%',#{drugName}),'%')
			</if>
			<if test="useableId!=0">
				and p.useableid=#{useableId}
			</if>
			<if test="miniId!=0">
				and p.drugnum&lt;=p.minimum
			</if>
		</where>
		)where r&gt;=#{pageNum}*#{pageLimit}-#{pageLimit}+1 and
		r&lt;=#{pageNum}*#{pageLimit}
	</select>

	<!-- 查询药房药品信息 -->
	<select id="selectOnePhaDrug" parameterType="Integer"
		resultMap="phaDrugMap">
		select
		s.*,p.PHADRUGID,p.DRUGNUM,p.USEABLEID,p.MINIMUM,p.MAXIMUM,ROWNUM r
		from tblphadrug p
		left join tblstodrug s on p.drugid=s.drugid where p.drugid=#{drugId}
	</select>

	<!-- 查询药品信息总数 -->
	<select id="findDrugCount"
		parameterType="org.great.bean.CondiBean"
		resultType="java.lang.Integer">
		select count(*) from tblstodrug a where 1=1
		<if test=" ''!=drugName and null !=drugName">and a.drugName like
			concat(concat('%',#{drugName,jdbcType=VARCHAR}),'%')</if>
		<if test=" ''!=drugId and 0 !=drugId">and a.drugId like
			concat(concat('%',#{drugId,jdbcType=NUMERIC}),'%')</if>
		<if test=" ''!=pinyinCode and null !=pinyinCode">and a.pinyinCode like
			concat(concat('%',#{pinyinCode,jdbcType=VARCHAR}),'%')</if>
		<if test=" ''!=typeId and 0 !=typeId">and a.typeId =#{typeId,jdbcType=NUMERIC}</if>

	</select>

	<!-- 查询药品信息 -->
	<select id="findDrugInfo"
		parameterType="org.great.bean.CondiBean" resultMap="stoDrugMap">
		select * from(select ROWNUM r, a.*,b.dosageform,c.drugtype,c.pid from
		tblstodrug a ,tbldf b ,tbldrugtype c where 1=1
		<if test=" ''!=drugName and null !=drugName">
			and a.drugName like concat(concat('%',#{drugName,jdbcType=VARCHAR}),'%')
		</if>
		<if test=" ''!=drugId and 0 !=drugId">
			and a.drugId like concat(concat('%',#{drugId,jdbcType=NUMERIC}),'%')
		</if>
		<if test=" ''!=pinyinCode and null !=pinyinCode">
			and a.pinyinCode like
			concat(concat('%',#{pinyinCode,jdbcType=VARCHAR}),'%')
		</if>
		<if test=" ''!=typeId and 0 !=typeId">
			and a.typeId =#{typeId,jdbcType=NUMERIC}
		</if>
		and a.typeid=c.typeid and a.dosageid=b.dosageid )
		where r&gt;=#{pageNum}*#{pageLimit}-#{pageLimit}+1 and
		r&lt;=#{pageNum}*#{pageLimit}
	</select>
	<resultMap type="org.great.bean.StoDrugBean" id="stoDrugMap">
		<id property="drugId" column="drugId" />
		<result property="drugName" column="drugName" />
		<result property="generalName" column="generalName" />
		<result property="specific" column="specific" />
		<result property="unit" column="unit" />
		<result property="retailPrice" column="retailPrice" />
		<result property="dosageId" column="dosageId" />
		<result property="usage" column="usage" />
		<result property="invoiceTitle" column="invoiceTitle" />
		<result property="pinyinCode" column="pinyinCode" />
		<result property="antibiotic" column="antibiotic" />
		<result property="dosage" column="dosage" />
		<result property="dailyNum" column="dailyNum" />
		<result property="typeId" column="typeId" />
		<result property="drugmanu" column="drugmanu" />
		<result property="proPlace" column="proPlace" />
		<association property="dfBean"
			javaType="org.great.bean.DfBean">
			<id property="dosageId" column="dosageId" />
			<result property="dosageForm" column="dosageForm" />
		</association>
		<association property="drugTypeBean"
			javaType="org.great.bean.DrugTypeBean">
			<id property="typeId" column="typeId" />
			<result property="pid" column="pid" />
			<result property="drugType" column="drugType" />
		</association>
	</resultMap>

	<!-- 药房的药品列表 -->
	<resultMap type="org.great.bean.PhaDrugBean" id="phaDrugMap">
		<id property="phaDrugId" column="phadrugid" />
		<result property="drugNum" column="DRUGNUM" />
		<result property="useableId" column="USEABLEID" />
		<result property="minimum" column="MINIMUM" />
		<result property="maximum" column="MAXIMUM" />
		<association property="stoDrugBean"
			javaType="org.great.bean.StoDrugBean">
			<id property="drugId" column="DRUGID" />
			<result property="drugName" column="drugname" />
			<result property="specific" column="specific" />
			<result property="drugmanu" column="drugmanu" />
			<result property="retailPrice" column="retailprice" />
			<result property="unit" column="unit" />
		</association>
	</resultMap>

	<!-- 调价记录列表 -->
	<resultMap type="org.great.bean.AdjustPriceBean"
		id="adjustPrice">
		<result property="adjustPriceId" column="adjustPriceid" />
		<result property="adjustDate" column="adjustdate" />

		<result property="beforeAdjust" column="beforeadjust" />
		<result property="afterAdjust" column="afterAdjust" />
		<result property="adminId" column="adminId" />
		<association property="adminBean"
			javaType="org.great.bean.AdminBean">
			<result property="adminName" column="adminname" />
		</association>
		<association property="stoDrugBean"
			javaType="org.great.bean.StoDrugBean">
			<id property="drugId" column="drugid" />
			<result property="drugName" column="drugname" />
			<result property="specific" column="specific" />
			<result property="drugmanu" column="drugmanu" />
			<result property="unit" column="unit" />
			<result property="retailPrice" column="retailprice" />
		</association>
	</resultMap>

	<!-- 药品入库批次详情列表 -->
	<resultMap type="org.great.bean.BatchDetailBean"
		id="batchDetailMap">
		<id property="batchDetailId" column="batchdetailid" />
		<result property="putBatch" column="putbatch" />
		<result property="drugId" column="drugid" />
		<result property="manuBatch" column="manubatch" />
		<result property="purPrice" column="purprice" />
		<association property="stoDrugBean"
			javaType="org.great.bean.StoDrugBean">
			<result property="drugName" column="drugname" />
			<result property="pinyinCode" column="pinyinCode" />
			<result property="drugmanu" column="drugmanu" />
		</association>
		<association property="outAndInbean"
			javaType="org.great.bean.OutAndInBean">
			<result property="handleDate" column="handledate" />
		</association>
	</resultMap>



	<!-- 药品申请列表 -->
	<resultMap type="org.great.bean.DrugApplyBean" id="drugApply">
		<id property="drugApplyId" column="DRUGAPPLYID" />
		<result property="drugId" column="drugid" />
		<result property="applyNum" column="applynum" />
		<result property="adminId" column="ADMINID" />
		<result property="applyDate" column="applydate" />
		<result property="applyReason" column="applyreason" />
		<result property="applyType" column="applytype" />
		<result property="checkName" column="checkname" />
		<result property="checkDate" column="checkdate" />
		<result property="manuBatch" column="manubatch" />
		<result property="putBatch" column="putbatch" />
		<result property="checkId" column="checkid" />
		<result property="applyTypeId" column="applytypeid" />
		<association property="adminBean" column="ADMINID"
			javaType="org.great.bean.AdminBean">
			<id property="adminId" column="adminid"></id>
			<result property="adminName" column="adminname" />
		</association>
		<association property="stoDrugBean" column="drugid"
			javaType="org.great.bean.StoDrugBean">
			<id property="drugId" column="drugid" />
			<result property="drugName" column="drugname" />
			<result property="drugmanu" column="drugmanu" />
			<result property="proPlace" column="proplace" />
		</association>
		<association property="bdBean"
			javaType="org.great.bean.BatchDetailBean">
			<result property="batchDetailId" column="batchdetailid" />
			<result property="purPrice" column="purprice" />
		</association>
	</resultMap>



	<!-- 蓝鹏鹏功能 -->
	<!-- 通过拼音码/id/名称 /查询可出售药品 -->
	<select id="selectCanSellDrug"
		parameterType="org.great.bean.StoDrugBean" resultMap="caceDruginfo">
		select s.*,p.drugNum,
		b.manuBatch,b.batchDetailId,b.purprice,b.putBatch,b.proDate,
		b.handleNum
		from TBLStoDrug
		s,tblbatchdetail
		b,tbloutandin o,tblPhaDrug p
		where
		s.drugid= b.drugid
		and o.putBatch=b.batchDetailId
		and
		s.drugid=p.drugid
		and o.placeId=21 and o.outInId=18
		and b.handlenum!=0
		<if test="pinyinCode!=null and pinyinCode!=''">
			and s.pinyinCode like
			concat(concat('%',#{pinyinCode}),'%')
		</if>
		<if test="drugId!=0">
			and s.drugId like concat(concat('%',#{drugId}),'%')
		</if>
		<if test="drugName!=null and drugName!=''">
			and s.drugName like concat(concat('%',#{drugName}),'%')
		</if>
		order by b.prodate asc
	</select>

	<insert id="insertBatchDetail"
		parameterType="org.great.bean.BatchDetailBean">
		<selectKey resultType="java.lang.Integer" order="BEFORE"
			keyProperty="batchDetailId">
			select SPMSSEQ.NEXTVAL from DUAL
		</selectKey>
		insert into tblbatchdetail
		(batchdetailid,PUTBATCH,MANUBATCH,DRUGID,PRODATE,HANDLENUM,PURPRICE,SELLPRICE,INDATE,TOTALMONEY)
		values(#{batchDetailId,jdbcType=NUMERIC},#{putBatch,jdbcType=VARCHAR},#{manuBatch,jdbcType=VARCHAR},#{drugId,jdbcType=NUMERIC},
		#{proDate,jdbcType=VARCHAR},#{handleNum,jdbcType=NUMERIC},#{purPrice,jdbcType=NUMERIC},#{sellPrice,jdbcType=NUMERIC}
		,#{inDate,jdbcType=VARCHAR},#{totalMoney,jdbcType=NUMERIC})
	</insert>
	<resultMap type="org.great.bean.StoDrugBean"
		id="caceDruginfo">
		<id property="drugId" column="drugId" />
		<result property="drugName" column="drugName" />
		<result property="generalName" column="generalName" />
		<result property="specific" column="specific" />
		<result property="unit" column="unit" />
		<result property="retailPrice" column="retailPrice" />
		<result property="dosageId" column="dosageId" />
		<result property="usage" column="usage" />
		<result property="invoiceTitle" column="invoiceTitle" />
		<result property="pinyinCode" column="pinyinCode" />
		<result property="antibiotic" column="antibiotic" />
		<result property="dosage" column="dosage" />
		<result property="typeId" column="typeId" />
		<result property="drugmanu" column="drugmanu" />
		<result property="proPlace" column="proPlace" />
		<association property="batchDetailBean" column="drugId"
			javaType="org.great.bean.BatchDetailBean">
			<result property="drugId" column="drugId"></result>
			<result property="batchDetailId" column="BATCHDETAILID" />
			<result property="putBatch" column="putBatch" />
			<result property="manuBatch" column="manuBatch" />
			<result property="proDate" column="proDate" />
			<result property="handleNum" column="HANDLENUM" />
			<result property="purPrice" column="PURPRICE" />
		</association>
		<association property="phaDrugBean" column="drugId"
			javaType="org.great.bean.PhaDrugBean">
			<id property="drugId" column="drugId"></id>
			<result property="drugNum" column="drugNum" />
		</association>
	</resultMap>

	<insert id="takeDrugAppleFor"
		parameterType="org.great.bean.DrugApplyBean">
		INSERT INTO TBLDRUGAPPLY (DRUGAPPLYID,ADMINID, DRUGID,
		APPLYNUM, APPLYDATE,
		CHECKID, APPLYTYPEID, APPLYREASON) VALUES
		(spmsseq.nextval
		,#{adminId}, #{drugId}, #{applyNum},
		(to_char(sysdate,'yyyy-mm-dd hh24:mi:ss')),
		7, 10,
		#{applyReason})
	</insert>
	<!-- 退库申请(lp) -->
	<insert id="cacellingApply"
		parameterType="org.great.bean.DrugApplyBean">
		INSERT INTO TBLDRUGAPPLY (DRUGAPPLYID,ADMINID, DRUGID,
		APPLYNUM, APPLYDATE,
		CHECKID, APPLYTYPEID,
		APPLYREASON,MANUBATCH) VALUES
		(spmsseq.nextval
		,#{adminId},
		#{drugId},
		#{applyNum},(to_char(sysdate,'yyyy-mm-dd hh24:mi:ss')),
		7,
		11,
		#{applyReason},#{manuBatch})
	</insert>

	<!-- 通过拼音码/id/名称 -->
	<select id="selectDrug"
		parameterType="org.great.bean.StoDrugBean" resultMap="druginfo">
		select s.*, d.dosageForm,i.inventoryNum from TBLStoDrug s,tbldf
		d,tblInventory i where s.dosageId=d.dosageId and i.drugId=s.drugId
		<if test="pinyinCode!=null and pinyinCode!=''">
			and s.pinyinCode like
			concat(concat('%',#{pinyinCode}),'%')
		</if>
		<if test="drugId!=-1">
			and s.drugId like concat(concat('%',#{drugId}),'%')
		</if>
		<if test="drugName!=null and drugName!=''">
			and s.drugName like concat(concat('%',#{drugName}),'%')
		</if>
	</select>
	<resultMap type="org.great.bean.StoDrugBean" id="druginfo">
		<id property="drugId" column="drugId" />
		<result property="drugName" column="drugName" />
		<result property="generalName" column="generalName" />
		<result property="specific" column="specific" />
		<result property="unit" column="unit" />
		<result property="retailPrice" column="retailPrice" />
		<result property="dosageId" column="dosageId" />
		<result property="usage" column="usage" />
		<result property="invoiceTitle" column="invoiceTitle" />
		<result property="pinyinCode" column="pinyinCode" />
		<result property="antibiotic" column="antibiotic" />
		<result property="dosage" column="dosage" />
		<result property="typeId" column="typeId" />
		<result property="drugmanu" column="drugmanu" />
		<result property="proPlace" column="proPlace" />
		<association property="dfBean" column="dosageId"
			javaType="org.great.bean.DfBean">
			<id property="dosageId" column="dosageId"></id>
			<result property="dosageForm" column="dosageForm" />
		</association>
		<association property="inventoryBean" column="drugId"
			javaType="org.great.bean.InventoryBean">
			<id property="drugId" column="drugId" />
			<result property="inventoryNum" column="inventoryNum" />

		</association>

	</resultMap>


	<!-- 查询药品申请记录(lp) -->
	<select id="selectCancellingApplyCount"
		parameterType="org.great.bean.CondiBean" resultType="Integer">
		select count(drugapplyid) from tbldrugapply d
		left join tbladmin a on
		d.adminid=a.adminid
		left join tblstodrug s on d.drugid=s.drugid
		<where>
			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and d.applydate &gt;=#{afterDate}
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and d.applydate &lt;=#{beforeDate}
			</if>
			<if test="checkId!=0 ">
				and d.checkid=#{checkId}
			</if>
			<if test="applyTypeId!=0 ">
				and d.applytypeid =#{applyTypeId}
			</if>

		</where>

	</select>


	<!-- 通过拼音码/id/名称 //生产日期查找退库药品 -->
	<select id="chooseCaceDrug"
		parameterType="org.great.bean.StoDrugBean" resultMap="caceDruginfo">
		select s.*,p.drugNum,o.outAndInId, b.manuBatch,b.putBatch,b.proDate,
		b.handleNum
		from TBLStoDrug
		s,tblbatchdetail
		b,tbloutandin o,tblPhaDrug p
		where
		s.drugid= b.drugid
		and o.putBatch=b.batchDetailId
		and
		s.drugid=p.drugid
		and o.placeId=21 and o.outInId=18 and
		o.drugSource='药库'
		<if test="pinyinCode!=null and pinyinCode!=''">
			and s.pinyinCode like
			concat(concat('%',#{pinyinCode}),'%')
		</if>
		<if test="drugId!=-1">
			and s.drugId like concat(concat('%',#{drugId}),'%')
		</if>
		<if test="drugName!=null and drugName!=''">
			and s.drugName like concat(concat('%',#{drugName}),'%')
		</if>

	</select>
	<resultMap type="org.great.bean.StoDrugBean"
		id="caceDruginfo">
		<id property="drugId" column="drugId" />
		<result property="drugName" column="drugName" />
		<result property="generalName" column="generalName" />
		<result property="specific" column="specific" />
		<result property="unit" column="unit" />
		<result property="retailPrice" column="retailPrice" />
		<result property="dosageId" column="dosageId" />
		<result property="usage" column="usage" />
		<result property="invoiceTitle" column="invoiceTitle" />
		<result property="pinyinCode" column="pinyinCode" />
		<result property="antibiotic" column="antibiotic" />
		<result property="dosage" column="dosage" />
		<result property="typeId" column="typeId" />
		<result property="drugmanu" column="drugmanu" />
		<result property="proPlace" column="proPlace" />
		<association property="batchDetailBean"
			column="batchDetailId" javaType="org.great.bean.BatchDetailBean">
			<id property="batchDetailId" column="batchDetailId" />
			<result property="putBatch" column="putBatch" />
			<result property="manuBatch" column="manuBatch" />
			<result property="proDate" column="proDate" />
			<result property="handleNum" column="HANDLENUM" />
		</association>
		<association property="phaDrugBean" column="phaDrugId"
			javaType="org.great.bean.PhaDrugBean">
			<id property="phaDrugId" column="phaDrugId" />
			<result property="drugNum" column="drugNum" />
		</association>
		<association property="outAndInBean" column="outAndInId"
			javaType="org.great.bean.OutAndInBean">
			<result property="outAndInId" column="outAndInId" />

		</association>
	</resultMap>
	<!--审核退库操作 -->
	<!-- 改变退库申请状态时间 -->
	<update id="updayeCaceApply" parameterType="String">
		update
		TBLDRUGAPPLY
		set checkId=6,checkDate=(to_char(sysdate,'yyyy-mm-dd
		hh24:mi:ss')),auditorId=#{1}
		where drugApplyId=#{0}
	</update>
	<select id="selectInfo"
		parameterType="org.great.bean.BatchDetailBean"
		resultType="org.great.bean.BatchDetailBean">
		select * from tblBatchDetail b ,tblOutAndIn o where
		b.drugId=#{drugId} and
		b.manuBatch=#{manuBatch} and o.putBatch
		=b.putBatch and o.placeId=22 and o.outInId=18
		and o.drugsource !='药房'
		and o.drugsource is not null
	</select>

	<select id="selectPhaInfo"
		parameterType="org.great.bean.BatchDetailBean"
		resultType="org.great.bean.BatchDetailBean">
		select * from tblBatchDetail b ,tblOutAndIn o where
		b.drugId=#{drugId} and o.putBatch=b.batchDetailId
		and
		b.manuBatch=#{manuBatch} and b.putBatch is null
		and o.placeId=21 and
		o.outInId=18 and o.drugsource ='药库'
	</select>
	<insert id="insetPhaBatch"
		parameterType="org.great.bean.BatchDetailBean">
		<selectKey resultType="java.lang.Integer" order="BEFORE"
			keyProperty="batchDetailId">
			select SPMSSEQ.NEXTVAL from DUAL
		</selectKey>
		INSERT INTO TBLBATCHDETAIL (BATCHDETAILID,
		MANUBATCH,
		DRUGID,
		PRODATE,
		HANDLENUM, PURPRICE, INDATE,
		TOTALMONEY)
		VALUES
		(#{batchDetailId},
		#{manuBatch},
		#{drugId}, #{proDate},
		#{handleNum},
		#{purPrice},
		#{inDate}, #{totalMoney})
	</insert>
	<insert id="insetPhaOut" parameterType="java.lang.Integer">
		INSERT INTO TBLOUTANDIN
		(OUTANDINID, TOTALMONEY,
		PUTBATCH, PLACEID,
		OUTINID, DESTINATION,
		HANDLEDATE, ADMINID) VALUES
		#{0}, (select TOTALMONEY from
		tblbatchdetail where
		BATCHDETAILID=#{0}), #{0},
		'21',
		'17', '药库',
		(to_char(sysdate,'yyyy-mm-dd hh24:mi:ss')),
		#{1})
	</insert>
	<update id="updatePutBatchNum" parameterType="java.lang.Integer">
		update
		tblBatchDetail
		set handleNum=handleNum+#{0} where drugid=#{2} and
		batchDetailId=#{1}
	</update>
	<update id="updatePhaDrugNum" parameterType="java.lang.Integer">
		update tblPhaDrug
		set drugnum=drugnum-#{0} where drugid=#{1}
	</update>
	<insert id="insetStoIn" parameterType="java.lang.String">
		INSERT INTO TBLOUTANDIN
		(OUTANDINID, TOTALMONEY,
		PUTBATCH, PLACEID,
		OUTINID,
		HANDLEDATE,
		ADMINID,drugSource) VALUES
		(spmsseq.nextval, (select TOTALMONEY from
		tblbatchdetail where
		BATCHDETAILID=(select max(BATCHDETAILID) from
		TBLBATCHDETAIL)), #{0},
		'22','18', (to_char(sysdate,'yyyy-mm-dd
		hh24:mi:ss')),
		#{1},'药房')
	</insert>
	<update id="updateStoDrugNum" parameterType="java.lang.Integer">
		update tblInventory
		set inventoryNum=inventoryNum+#{0} where drugid=#{1}
	</update>
	<update id="updatePhaBatchNum"
		parameterType="org.great.bean.BatchDetailBean">
		update tblBatchDetail set totalMoney=#{totalMoney},
		handleNum=handleNum-#{handleNum} where
		batchDetailId =#{batchDetailId}
	</update>
	<!-- 完成审核退库 -->

	<!--不同意申请 改变退库申请状态时间 -->
	<update id="chickError" parameterType="java.lang.String">
		update
		TBLDRUGAPPLY
		set
		checkId=8,
		checkDate=(to_char(sysdate,'yyyy-mm-dd
		hh24:mi:ss')),auditorId=#{1}
		where drugApplyId=#{0}
	</update>
	<select id="selApply" parameterType="java.lang.String"
		resultType="org.great.bean.DrugApplyBean">
		select * from tblDRUGAPPLY where drugApplyId=#{0}
	</select>



	<!-- 同意药品请领 -->
	<select id="selectStoIn" parameterType="java.lang.Integer"
		resultType="org.great.bean.BatchDetailBean">
		select * from
		tblbatchdetail where drugid=#{0} and putbatch
		in(select
		putbatch from
		tbloutandin where placeid=22 and outinid=18 and
		drugsource !='药房' and drugsource is not null ) order by prodate
	</select>
	<insert id="insetStoOut" parameterType="java.lang.String">
		INSERT INTO TBLOUTANDIN
		(OUTANDINID, TOTALMONEY,
		PUTBATCH, PLACEID,
		OUTINID,
		HANDLEDATE,
		ADMINID
		,destination) VALUES
		(spmsseq.nextval, (select TOTALMONEY from
		tblbatchdetail where
		BATCHDETAILID=#{0}), #{0},
		'22','17',
		(to_char(sysdate,'yyyy-mm-dd
		hh24:mi:ss')),
		#{1},'药房')
	</insert>
	<insert id="insetPhaInt" parameterType="java.lang.Integer">
		INSERT INTO TBLOUTANDIN
		(OUTANDINID, TOTALMONEY,PUTBATCH, PLACEID,OUTINID,
		drugSource,HANDLEDATE, ADMINID)
		VALUES
		(spmsseq.nextval, (select TOTALMONEY from
		tblbatchdetail where
		BATCHDETAILID=#{0}), #{0} ,
		'21',
		'18','药库',(to_char(sysdate,'yyyy-mm-dd hh24:mi:ss')),
		#{1})
	</insert>
	<update id="updateTakeApply" parameterType="java.lang.String">
		update
		TBLDRUGAPPLY
		set checkId=6,checkDate=(to_char(sysdate,'yyyy-mm-dd hh24:mi:ss')),
		auditorId=#{1},manuBatch=#{2}
		where drugApplyId=#{0}

	</update>

	<update id="reduceStoDrugNum" parameterType="java.lang.Integer">
		update tblInventory
		set inventoryNum=inventoryNum-#{0} where drugid=#{1}
	</update>


	<update id="addPhaDrugNum" parameterType="java.lang.Integer">
		update tblPhaDrug
		set
		drugnum=drugnum+#{0} where drugid=#{1}
	</update>

	<select id="selSpecific" parameterType="java.lang.Integer"
		resultType="String">
		select specific from tblStoDrug where drugid=#{0}
	</select>
	<select id="selBatchBean" parameterType="java.lang.String"
		resultType="org.great.bean.BatchDetailBean">
		select * from tblBatchDetail b ,tblOutAndIn o where
		b.drugId=#{0} and
		o.putBatch=b.batchDetailId
		and
		b.manuBatch=#{1} and
		b.putBatch is null
		and o.placeId=21 and
		o.outInId=18 and o.drugsource
		='药库'
	</select>
</mapper>