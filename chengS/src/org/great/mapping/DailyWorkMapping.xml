<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" 
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="org.great.mapper.DailyWorkMapper"> 

<!-- 陈文炽完成功能 -->

<!-- 报损审核 -->
	<update id="breakCheck" parameterType="org.great.bean.DrugApplyBean" >
		update tbldrugapply set checkid=#{checkId} where drugapplyid=#{drugApplyId}
	</update>
	
<!-- 报损申请 -->
	<insert id="breakApply" parameterType="org.great.bean.DrugApplyBean">
		insert into tbldrugapply (DRUGAPPLYID,ADMINID,DRUGID,APPLYNUM,APPLYDATE,CHECKID,APPLYTYPEID,APPLYREASON,manubatch,checkdate)
  values (SPMSSEQ.NEXTVAL,#{adminId,jdbcType=NUMERIC},#{drugId,jdbcType=NUMERIC},#{applyNum,jdbcType=NUMERIC},
  to_char(sysdate,'YYYY-MM-DD HH24:MI:SS'),#{checkId,jdbcType=NUMERIC},#{applyTypeId,jdbcType=NUMERIC},#{applyReason,jdbcType=VARCHAR},#{manuBatch,jdbcType=VARCHAR},#{checkDate,jdbcType=VARCHAR})
	</insert>

<!-- 查看申请记录 -->
	<select id="selectDrugApply" parameterType="org.great.bean.CondiBean" resultMap="drugApply">
	select * from(select d.*,a.adminname,s.drugname, p1.param checkname,s.drugmanu,b.purPrice,p2.param applytype,rownum r from tbldrugapply d
 	left join tblparam p1 on d.checkid=p1.paramid 
	left join tblparam p2 on d.applytypeid=p2.paramid 
	left join tbladmin a on d.adminid=a.adminid 
	left join tblstodrug s on d.drugid=s.drugid
	left join tblBatchDetail b on d.drugid=b.drugid and b.manubatch=d.manubatch and b.putbatch=d.putbatch
	<where>
			 
			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')  
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and d.applydate &gt;=#{afterDate} 
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and d.applydate &lt;=#{beforeDate} 
			</if>
			<if test="checkId!=0 ">
				and d.checkid=#{checkId}
			</if>
			<if test="applyTypeId!=0 ">
				and d.applytypeid =#{applyTypeId}
			</if>
			
		</where>
	
	 )where r&gt;=#{pageNum}*#{pageLimit}-#{pageLimit}+1 and r&lt;=#{pageNum}*#{pageLimit}
	</select>
	
	<!--  查询药品申请记录总数-->
	<select id="getDrugApplyCount" parameterType="org.great.bean.CondiBean" resultType="Integer">
		select count(drugapplyid) from tbldrugapply d
		 left join tbladmin a on d.adminid=a.adminid 
		 left join tblstodrug s on d.drugid=s.drugid 
		 <where>
					 
					<if test="adminName!=null and adminName!=''">
						and a.adminName like concat(concat('%',#{adminName}),'%')  
					</if>
					<if test="afterDate!=null and afterDate!='' ">
						and d.applydate &gt;=#{afterDate} 
					</if>
					<if test="beforeDate!=null and beforeDate!='' ">
						and d.applydate &lt;=#{beforeDate} 
					</if>
					<if test="checkId!=0 ">
						and d.checkid=#{checkId}
					</if>
					<if test="applyTypeId!=0 ">
						and d.applytypeid =#{applyTypeId}
					</if>
			
		</where>
 
	</select>
	
	<!-- 获取入库批次详情列表 -->
	<select id="selectPutDrug" parameterType="org.great.bean.CondiBean" resultMap="batchDetail">
		select s.drugname,s.drugmanu,b.putbatch,o.handledate,b.manubatch,b.purprice  from  tblbatchdetail b
		 left join tblstodrug s on b.drugid=s.drugid
		 left join tbloutandin o on b.putbatch=o.putbatch 
		 
		 <where>
				<if test="afterDate!=null and afterDate!='' ">
						and o.handledate &gt;=#{afterDate} 
				</if>
				<if test="beforeDate!=null and beforeDate!='' ">
						and o.handledate &lt;=#{beforeDate} 
				</if>
				<if test="pinyinCode!=null and pinyinCode!=''">
						and s.pinyincode like concat(concat('%',#{pinyinCode}),'%') 
				</if>
				<if test="drugName!=null and drugName!=''">
						and s.drugname like concat(concat('%',#{drugName}),'%') 
				</if>
				<if test="manuBatch!=null and manuBatch!=''">
						and b.manuBatch like concat(concat('%',#{manuBatch}),'%') 
				</if>
		 </where>
		 order by o.handledate
	</select>
	
	<!-- 插入药品调价记录 -->
	<insert id="insertAdjustPrice" parameterType="org.great.bean.AdjustPriceBean">
		insert into tbladjustprice (adjustpriceid,adjustdate,drugid,beforeadjust,afteradjust,adminid)
		 values(spmsseq.nextval,to_char(sysdate,'YYYY-MM-DD HH24:MI:SS'),#{drugId,jdbcType=NUMERIC},#{beforeAdjust,jdbcType=NUMERIC},#{afterAdjust,jdbcType=NUMERIC},#{adminId,jdbcType=NUMERIC})
	</insert>
	
	<!-- 获取调价记录总数 -->
	<select id="getAdjustCount" parameterType="org.great.bean.CondiBean" resultType="Integer">
		select count(a.adjustpriceid) from tbladjustprice a 
		left join tblstodrug s on a.drugid=s.drugid 
		left join tbladmin m on a.adminid=m.adminid
		<where>
			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')  
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and o.handledate &gt;=#{afterDate} 
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and o.handledate &lt;=#{beforeDate} 
			</if>
			<if test="pinyinCode!=null and pinyinCode!=''">
						and s.pinyincode like concat(concat('%',#{pinyinCode}),'%') 
				</if>
				<if test="drugName!=null and drugName!=''">
						and s.drugname like concat(concat('%',#{drugName}),'%') 
				</if>
		</where>
	</select>
	
	<!-- 获取调价记录列表 -->
	<select id="selectAdjustPrice" parameterType="org.great.bean.CondiBean" resultMap="adjustPrice">
		select * from(select a.*,s.drugname,s.unit,s.specific,s.drugmanu,m.adminname,rownum r from tbladjustprice a 
		left join tblstodrug s on a.drugid=s.drugid 
		left join tbladmin m on a.adminid=m.adminid
		<where>
			<if test="adminName!=null and adminName!=''">
				and a.adminName like concat(concat('%',#{adminName}),'%')  
			</if>
			<if test="afterDate!=null and afterDate!='' ">
				and o.handledate &gt;=#{afterDate} 
			</if>
			<if test="beforeDate!=null and beforeDate!='' ">
				and o.handledate &lt;=#{beforeDate} 
			</if>
			<if test="pinyinCode!=null and pinyinCode!=''">
						and s.pinyincode like concat(concat('%',#{pinyinCode}),'%') 
				</if>
				<if test="drugName!=null and drugName!=''">
						and s.drugname like concat(concat('%',#{drugName}),'%') 
				</if>
		</where>
		)where r&gt;=#{pageNum}*#{pageLimit}-#{pageLimit}+1 and r&lt;=#{pageNum}*#{pageLimit}
	</select>
	
	<!-- 获取参数值 -->
	<select id="getParam" parameterType="Integer" resultType="org.great.bean.ParamBean">
		select * from tblparam where paramid=#{paramId}
	</select>
	
	<!-- 插入药房出库记录 -->
	<insert id="insertDrugOut" parameterType="org.great.bean.OutAndInBean">
		insert into tbloutandin (OUTANDINID,PUTBATCH,PLACEID,OUTINID,DESTINATION,HANDLEDATE,ADMINID) 
		values(SPMSSEQ.NEXTVAL,#{putBatch,jdbcType=VARCHAR},#{placeId,jdbcType=NUMERIC},#{outInId,jdbcType=NUMERIC},
		#{destination,jdbcType=VARCHAR},to_char(sysdate,'YYYY-MM-DD HH24:MI:SS'),#{adminId,jdbcType=NUMERIC})
	</insert>
	
	<!-- 插入销售记录表 -->
	
	<!-- 调整药品价格 -->
	<update id="adjustPrice" parameterType="org.great.bean.AdjustPriceBean">
		update tblstodrug set retailprice=#{afterAdjust} where drugid=#{drugId}
	</update>
	<!-- 调价记录列表 -->
	<resultMap type="org.great.bean.AdjustPriceBean" id="adjustPrice">
		<result property="adjustPriceId" column="adjustPriceid"/>
		<result property="adjustDate" column="adjustdate"/>
		<result property="drugId" column="drugId"/>
		<result property="beforeAdjust" column="beforeadjust"/>
		<result property="afterAdjust" column="afterAdjust"/>
		<result property="adminId" column="adminId"/>
		<association property="adminBean" javaType="org.great.bean.AdminBean">
			<result property="adminName" column="adminname"/>
		</association>
		<association property="stoDrugBean" javaType="org.great.bean.StoDrugBean">
			<result property="drugName" column="drugname"/>
			<result property="specific" column="specific"/>
			<result property="drugmanu" column="drugmanu"/>
			<result property="unit" column="unit"/>
		</association>
	</resultMap>
	
	<!-- 药品入库批次详情列表 -->
	<resultMap type="org.great.bean.BatchDetailBean" id="batchDetail">
		<!-- <id property="batchDetailId" column="batchdetailid"/> -->
		<result property="putBatch" column="putbatch"/>
		<result property="manuBatch" column="manubatch"/>
		<result property="purPrice" column="purprice"/>
		<association property="stoDrugBean"  javaType="org.great.bean.StoDrugBean">
			<!-- <id property="drugId" column="drugid"></id> -->
			<result property="drugName" column="drugname"/>
			<result property="pinyinCode" column="pinyinCode"/>
			<result property="drugmanu" column="drugmanu"/>
		</association>
		<association property="outAndInbean" javaType="org.great.bean.OutAndInBean">
			<result property="handleDate" column="handledate"/>
		</association>
	</resultMap>
	
<!-- 	药品申请列表 -->
	<resultMap type="org.great.bean.DrugApplyBean" id="drugApply">
		<id property="drugApplyId" column="DRUGAPPLYID"/>
		<result property="applyNum" column="applynum"/>
		<result property="adminId" column="ADMINID"/>
		<result property="applyDate" column="applydate"/>
		<result property="applyReason" column="applyreason"/>
		<result property="applyType" column="applytype"/>
		<result property="checkName" column="checkname"/>
		<result property="checkDate" column="checkdate"/>
		<result property="manuBatch" column="manubatch"/>
		<result property="putBatch" column="putbatch"/>
		<result property="checiId" column="checkid"/>
		<result property="applyTypeId" column="applytypeid"/>
		<association property="adminBean" column="ADMINID" javaType="org.great.bean.AdminBean">
			<id property="adminId" column="adminid"></id>
			<result property="adminName" column="adminname"/>
		</association>
		<association property="stoDrugBean" column="drugid" javaType="org.great.bean.StoDrugBean"> 
			<id property="drugId" column="drugid"/>
			<result property="drugName" column="drugname"/>
			<result property="drugmanu" column="drugmanu"/>
			<result property="proPlace" column="proplace"/>
		</association>
		<association property="bdBean" javaType="org.great.bean.BatchDetailBean">
			<id property="batchDetailId" column="batchdetailid"/>
			<result property="purPrice" column="purprice"/>
		</association>
	</resultMap>

</mapper>